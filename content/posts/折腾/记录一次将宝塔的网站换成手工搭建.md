+++
title = "è®°å½•ä¸€æ¬¡å°†å®å¡”çš„ç½‘ç«™æ¢æˆæ‰‹å·¥æ­å»º"
date = "2024-09-16T00:00:00+08:00"
categories = ["æŠ˜è…¾"]
tags = ["debian", "linux", "nginx", "å®å¡”"]
+++

## åŸå› 

vps çš„å®å¡”çš„ Let's encrypt è¯ä¹¦ä¸‰ä¸ªæœˆåæ— æ³•è‡ªåŠ¨ç»­ç­¾ã€‚ä¸çŸ¥é“æ˜¯åŸå› ã€‚ç®—äº†, æ‰‹å·¥æ­å»º, ç„¶å acme.sh è‡ªåŠ¨ç»­ç­¾è¯ä¹¦ã€‚

## acme.sh ç”³è¯·è¯ä¹¦

```sh
#!/bin/bash

# è®¾ç½® acme.sh è·¯å¾„å˜é‡
ACME_SCRIPT="/root/.acme.sh/acme.sh"

# è®¾ç½® Cloudflare API å‡­æ®
export CF_Token=""        # æˆ‘çš„ä¸ªäººèµ„æ–™ -> API ä»¤ç‰Œ -> åˆ›å»ºä»¤ç‰Œ
export CF_Account_ID=""   # è¿›å…¥åŸŸ -> å³ä¸‹è§’çš„ "å¸æˆ·ID"

# å°†åŸŸåæ”¾å…¥æ•°ç»„å˜é‡
DOMAINS=(
    "foo.domain.com"
    "bar.domain.com"
)

# æ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
echo "========================================"
echo "å¼€å§‹ä¸º ${#DOMAINS[@]} ä¸ªåŸŸåç”³è¯· SSL è¯ä¹¦"
echo "ä½¿ç”¨çš„ acme.sh: $ACME_SCRIPT"
echo "========================================"
echo ""

# æ£€æŸ¥ acme.sh æ˜¯å¦å­˜åœ¨
if [ ! -f "$ACME_SCRIPT" ]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° acme.sh è„šæœ¬: $ACME_SCRIPT"
    echo "è¯·å…ˆå®‰è£… acme.sh: curl https://get.acme.sh | sh"
    exit 1
fi

# ä¸ºæ¯ä¸ªåŸŸåç”³è¯·è¯ä¹¦
for domain in "${DOMAINS[@]}"; do
    echo "ğŸ”„ æ­£åœ¨ä¸º $domain ç”³è¯·è¯ä¹¦..."

    # ç”³è¯·è¯ä¹¦
    "$ACME_SCRIPT" --issue -d "$domain" --dns dns_cf

    # æ£€æŸ¥ä¸Šä¸€æ¡å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
    if [ $? -eq 0 ]; then
        echo "âœ… $domain è¯ä¹¦ç”³è¯·å®Œæˆ"
    else
        echo "âŒ $domain è¯ä¹¦ç”³è¯·å¤±è´¥"
    fi

    echo ""
done

echo "========================================"
echo "è¯ä¹¦ç”³è¯·æµç¨‹å®Œæˆ"
echo "========================================"

# æ˜¾ç¤ºæ‰€æœ‰è¯ä¹¦çŠ¶æ€
echo ""
echo "ğŸ“‹ è¯ä¹¦çŠ¶æ€åˆ—è¡¨:"
"$ACME_SCRIPT" --list
```

åˆ—å‡º acme ç®¡ç†çš„åŸŸå:

```sh
acme.sh --list
```

## åˆ›å»ºåŸŸåé…ç½®å’ŒåŸŸåæ‰€ç”¨åˆ°çš„ç›®å½•

```sh
mkdir -p /etc/nginx/{sites-available,sites-enabled}
touch /etc/nginx/sites-available/{foo.domain.com,bar.domain.com}

mkdir -p /var/www/{foo.domain.com,bar.domain.com}/html
chown $USER:www-data -R /var/www/{foo.domain.com,bar.domain.com}/html

ln -s /etc/nginx/sites-available/foo.domain.com /etc/nginx/sites-enabled/
ln -s /etc/nginx/sites-available/bar.domain.com /etc/nginx/sites-enabled/
```

/etc/nginx/sites-available/foo.domain.com:

```
server {
     listen 80;
     listen [::]:80;
     server_name foo.domain.com;

     # é‡å®šå‘æ‰€æœ‰ HTTP è¯·æ±‚åˆ° HTTPS
     return 301 https://$server_name$request_uri;
 }

 server {
     listen 443 ssl http2;
     listen [::]:443 ssl http2;
     server_name foo.domain.com;

     # SSL è¯ä¹¦è·¯å¾„
     ssl_certificate /root/.acme.sh/foo.domain.com_ecc/fullchain.cer;
     ssl_certificate_key /root/.acme.sh/foo.domain.com_ecc/foo.domain.com.key;

     # SSL é…ç½®
     ssl_protocols TLSv1.2 TLSv1.3;
     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256- GCM-SHA384;
     ssl_prefer_server_ciphers off;

     # HSTS (å¯é€‰)
     add_header Strict-Transport-Security "max-age=63072000" always;

     root /var/www/foo.domain.com/html;
     index index.html index.htm;

     location / {
         try_files $uri $uri/ =404;
     }

     # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
     location ~ /\. {
         deny all;
         access_log off;
         log_not_found off;
     }

     access_log /var/log/nginx/foo.domain.com.access.log;
     error_log /var/log/nginx/foo.domain.com.error.log;
 }
```

å…¶ä»–åŒç†ã€‚

## æ­å»º [sub-web](https://github.com/CareyWang/sub-web)

å°†æ„å»ºå¥½çš„ç½‘é¡µæ–‡ä»¶å¤åˆ¶åˆ°ç½‘ç«™çš„ç›®å½•:

```sh
cp sub-web/dist/* /var/www/foo.domain.com/html/ -r
```

Test:

```
curl -L foo.domain.com
```

## ä¸º [subconverter](https://github.com/tindy2013/subconverter) æ­å»ºåå‘ä»£ç†

ç›®çš„: é€šè¿‡ cloudflare çš„ä»£ç† (ä»£ç†çŠ¶æ€è®°å¾—æ‰“å¼€), é˜²æ­¢ ip æš´éœ²ã€‚

/etc/nginx/sites-available/bar.domain.com:

```
  # ä»£ç†ç›¸å…³å¤´éƒ¨
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # åå‘ä»£ç†é…ç½®
    location / {
        # åå‘ä»£ç†åˆ°æœ¬åœ°æœåŠ¡
        proxy_pass http://127.0.0.1:<port>;

        # ä»£ç†è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ç¼“å†²åŒºè®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
```

Test:

```sh
dig bar.domain.com
```

## æ·»åŠ è®¢é˜…æ–‡ä»¶ç«™ç‚¹

/etc/nginx/sites-available/baz.domain.com:

```
    # æ ¹ç›®å½• - è¿”å›404ï¼Œä¸æä¾›ä»»ä½•ä¿¡æ¯
    location = / {
        return 404;
        access_log off;
        log_not_found off;
    }

    # ä¸»æ–‡ä»¶æœåŠ¡ä½ç½®
    location /file/ {
        # æ–‡ä»¶æ ¹ç›®å½•
        alias /www/server/file_store/;

        # å…³é”®å®‰å…¨è®¾ç½®ï¼šå®Œå…¨ç¦ç”¨ç›®å½•æµè§ˆ
        autoindex off;

        # ç¦ç”¨ç¬¦å·é“¾æ¥è·Ÿéš
        disable_symlinks on;

        # å°è¯•è®¿é—®æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›404
        try_files $uri =404;

        # å®‰å…¨å¤´éƒ¨
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;

        # æ ¹æ®æ–‡ä»¶æ‰©å±•åè®¾ç½®MIMEç±»å‹
        location ~* \.yaml$ {
            types { }
            default_type application/yaml;
            add_header Content-Disposition "attachment";
        }

        location ~* \.yml$ {
            types { }
            default_type application/yaml;
            add_header Content-Disposition "attachment";
        }

        location ~* \.json$ {
            types { }
            default_type application/json;
        }

        location ~* \.txt$ {
            types { }
            default_type text/plain;
        }
    }

    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶ï¼ˆ.å¼€å¤´çš„æ–‡ä»¶ï¼‰
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # å¯é€‰ï¼šé™åˆ¶æŸäº›æ•æ„Ÿæ–‡ä»¶æ‰©å±•å
    location ~* \.(conf|config|ini|sql|env)$ {
        deny all;
        return 404;
    }
```

Test:

```sh
curl -LO https://baz.domain.com/file/<file_name>
```

## æ·»åŠ åŸŸåé‡å®šå‘

ç›®çš„: ç®€å•åœ°ä¼ªè£…å¤§æµé‡ç½‘ç«™ (ç½‘ç›˜ç½‘ç«™)

```
server {
    listen 80;
    listen [::]:80;
    server_name qux.domain.com;

    # HTTP é‡å®šå‘åˆ°ç›®æ ‡ç½‘ç«™
    return 301 http://pan.qiangsungroup.cn$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name qux.domain.com;

    # SSL è¯ä¹¦è·¯å¾„ï¼ˆä¿æŒåŸæœ‰è¯ä¹¦ï¼‰
    ssl_certificate /root/.acme.sh/qux.domain.com_ecc/fullchain.cer;
    ssl_certificate_key /root/.acme.sh/qux.domain.com_ecc/qux.domain.com.key;

    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # HTTPS ä¹Ÿé‡å®šå‘åˆ°ç›®æ ‡ç½‘ç«™ï¼ˆæ³¨æ„ï¼šç›®æ ‡ç½‘ç«™æ˜¯ HTTPï¼‰
    return 301 http://pan.qiangsungroup.cn$request_uri;

    # å¯é€‰ï¼šæ·»åŠ ä¸€äº›å¤´éƒ¨ä¿¡æ¯
    add_header X-Redirected-From "qux.domain.com" always;
    add_header X-Redirected-To "pan.qiangsungroup.cn" always;
}
```

Test:

```sh
curl -L qux.domain.com
```
